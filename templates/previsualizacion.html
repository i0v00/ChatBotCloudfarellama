
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/EXRLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<style>
    .preview-canvas {
        width: 100%;
        height: 200px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .preview-canvas:hover {
        transform: scale(1.05);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
    }

    .modal-content {
        position: relative;
        width: 90%;
        height: 90%;
        margin: 2.5% auto;
        background: #333;
        border-radius: 10px;
        overflow: hidden;
    }

    .modal-canvas {
        width: 100%;
        height: calc(100% - 60px);
    }

    .modal-header {
        background: #8B4513;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
    }

    .close:hover {
        color: #D2691E;
    }

    .controls-panel {
        position: absolute;
        top: 80px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-size: 12px;
        max-width: 200px;
    }

    .product-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .product-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .add-product-btn {
        border: 2px dashed #8B4513;
        background: rgba(139, 69, 19, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .add-product-btn:hover {
        background: rgba(139, 69, 19, 0.2);
        border-color: #D2691E;
    }
</style>

<!-- Contenedor principal -->
<div class="container mx-auto px-4 py-8">


    <!-- Formulario para agregar producto (oculto inicialmente) -->
    <div id="formularioProducto" class="hidden mb-8 bg-white p-6 rounded-lg shadow-lg">
        <h3 class="text-xl font-bold mb-4">Agregar Nuevo Producto</h3>
        <div class="grid md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label>
                <input type="text" id="nombreProducto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Precio</label>
                <input type="text" id="precioProducto" placeholder="15 BS" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                <textarea id="descripcionProducto" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ruta del Modelo 3D</label>
                <input type="text" id="modeloProducto" placeholder="/static/modelos/modelo1/scene.gltf" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
            </div>
        </div>
        <div class="mt-4 flex space-x-4">
            <button onclick="agregarProducto()" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-md transition-colors">
                Agregar Producto
            </button>
            <button onclick="ocultarFormularioProducto()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Grid de productos -->
    <div id="productosGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        <!-- Los productos se generarán dinámicamente aquí -->
    </div>
</div>

<!-- Modal para visualización 3D con ejes -->
<div id="modelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle" class="text-xl font-bold">Producto 3D</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div id="modalViewer" class="modal-canvas"></div>

        <!-- Panel de controles -->
        <div class="controls-panel">
            <div class="mb-2"><strong>Controles:</strong></div>
            <div>• Clic izquierdo + arrastrar: Rotar</div>
            <div>• Rueda del mouse: Zoom</div>
            <div>• Clic derecho + arrastrar: Mover</div>
            <div class="mt-2"><strong>Ejes:</strong></div>
            <div style="color: #ff0000;">• X - Rojo</div>
            <div style="color: #00ff00;">• Y - Verde</div>
            <div style="color: #0000ff;">• Z - Azul</div>
        </div>
    </div>
</div>

<script>
// Variables globales
let modalScene, modalCamera, modalRenderer, modalControls;
let previewScenes = [];
let previewRenderers = [];
let axesHelper;
let productos = [
    { id: 1, nombre: 'Cupcake Deluxe', precio: '15 BS', descripcion: 'Delicioso cupcake con decoración artesanal', modelo: '/static/modelos/modelo1/scene.gltf' },
    { id: 2, nombre: 'Torta Especial', precio: '45 BS', descripcion: 'Torta de chocolate con decoración elegante', modelo: '/static/modelos/modelo2/scene.gltf' },
    { id: 3, nombre: 'Dona Glaseada', precio: '8 BS', descripcion: 'Dona suave con glaseado de colores', modelo: '/static/modelos/modelo3/scene.gltf' }
];

// Clase para manejar productos 3D (código reutilizable)
class ProductoViewer3D {
    constructor() {
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.controls = null;
        this.model = null;
    }

    // Crear ejes de coordenadas personalizados (código reutilizable)
    createAxesHelper(size = 2) {
        const axesGroup = new THREE.Group();

        // Eje X (Rojo)
        const xGeometry = new THREE.CylinderGeometry(0.02, 0.02, size);
        const xMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const xAxis = new THREE.Mesh(xGeometry, xMaterial);
        xAxis.rotation.z = -Math.PI / 2;
        xAxis.position.x = size / 2;
        axesGroup.add(xAxis);

        // Flecha X
        const xArrowGeometry = new THREE.ConeGeometry(0.05, 0.2);
        const xArrow = new THREE.Mesh(xArrowGeometry, xMaterial);
        xArrow.rotation.z = -Math.PI / 2;
        xArrow.position.x = size;
        axesGroup.add(xArrow);

        // Eje Y (Verde)
        const yGeometry = new THREE.CylinderGeometry(0.02, 0.02, size);
        const yMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const yAxis = new THREE.Mesh(yGeometry, yMaterial);
        yAxis.position.y = size / 2;
        axesGroup.add(yAxis);

        // Flecha Y
        const yArrowGeometry = new THREE.ConeGeometry(0.05, 0.2);
        const yArrow = new THREE.Mesh(yArrowGeometry, yMaterial);
        yArrow.position.y = size;
        axesGroup.add(yArrow);

        // Eje Z (Azul)
        const zGeometry = new THREE.CylinderGeometry(0.02, 0.02, size);
        const zMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
        const zAxis = new THREE.Mesh(zGeometry, zMaterial);
        zAxis.rotation.x = Math.PI / 2;
        zAxis.position.z = size / 2;
        axesGroup.add(zAxis);

        // Flecha Z
        const zArrowGeometry = new THREE.ConeGeometry(0.05, 0.2);
        const zArrow = new THREE.Mesh(zArrowGeometry, zMaterial);
        zArrow.rotation.x = Math.PI / 2;
        zArrow.position.z = size;
        axesGroup.add(zArrow);

        return axesGroup;
    }

    // Inicializar preview (código reutilizable)
    initPreview(canvas, modelPath) {
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });

        this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        this.renderer.setClearColor(0xf5f5f5);

        // Iluminación básica
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        this.scene.add(directionalLight);

        this.camera.position.set(2, 2, 2);
        this.camera.lookAt(0, 0, 0);

        // Cargar modelo
        const loader = new THREE.GLTFLoader();
        loader.load(modelPath, (gltf) => {
            this.model = gltf.scene;

            // Centrar y escalar modelo
            const box = new THREE.Box3().setFromObject(this.model);
            const center = new THREE.Vector3();
            box.getCenter(center);
            this.model.position.sub(center);


            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 1.5 / maxDim;
            this.model.scale.setScalar(scale);

            this.scene.add(this.model);

            this.animate();

        }, undefined, (error) => {
            console.error('Error cargando modelo:', error);
            // Crear placeholder
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            this.model = new THREE.Mesh(geometry, material);
            this.scene.add(this.model);
            this.animate();
        });
    }

    // Animación (código reutilizable)
    animate() {
        requestAnimationFrame(() => this.animate());
        if (this.model) {
            this.model.rotation.y += 0.01;
        }
        this.renderer.render(this.scene, this.camera);
    }
}

// Generar tarjetas de productos dinámicamente
function generarProductos() {
    const grid = document.getElementById('productosGrid');
    grid.innerHTML = '';

    productos.forEach(producto => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.innerHTML = `
            <div class="p-4">
                <canvas class="preview-canvas" id="preview-${producto.id}"></canvas>
            </div>
            <div class="p-6">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold text-gray-800">${producto.nombre}</h3>

                </div>
                <p class="text-gray-600 mb-3">${producto.descripcion}</p>
                <div class="flex justify-between items-center">
                    <span class="text-2xl font-bold text-amber-600">${producto.precio}</span>
                    <button
                      onclick="agregarAlCarrito('${producto.nombre}', '${producto.modelo}')"
                      class="bg-green-600 text-white px-4 py-2 rounded-full hover:bg-green-700 transition-colors flex items-center gap-2"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                           viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.5 4.5m0 0a1.5 1.5 0 103 0m-3 0H17m0 0a1.5 1.5 0 103 0m-3 0L7 13" />
                      </svg>
                      Agregar al carrito
                    </button>

                </div>
            </div>
        `;
        grid.appendChild(productCard);
    });

    // Inicializar previsualizaciones
    setTimeout(() => {
        productos.forEach(producto => {
            const canvas = document.getElementById(`preview-${producto.id}`);
            if (canvas) {
                const viewer = new ProductoViewer3D();
                viewer.initPreview(canvas, producto.modelo);
            }
        });
    }, 100);
}

// Mostrar formulario para agregar producto
function mostrarFormularioProducto() {
    document.getElementById('formularioProducto').classList.remove('hidden');
}

// Ocultar formulario
function ocultarFormularioProducto() {
    document.getElementById('formularioProducto').classList.add('hidden');
    // Limpiar campos
    document.getElementById('nombreProducto').value = '';
    document.getElementById('precioProducto').value = '';
    document.getElementById('descripcionProducto').value = '';
    document.getElementById('modeloProducto').value = '';
}

// Agregar nuevo producto
function agregarProducto() {
    const nombre = document.getElementById('nombreProducto').value;
    const precio = document.getElementById('precioProducto').value;
    const descripcion = document.getElementById('descripcionProducto').value;
    const modelo = document.getElementById('modeloProducto').value;

    if (!nombre || !precio || !descripcion || !modelo) {
        alert('Por favor, completa todos los campos');
        return;
    }

    const nuevoId = Math.max(...productos.map(p => p.id)) + 1;
    const nuevoProducto = {
        id: nuevoId,
        nombre: nombre,
        precio: precio,
        descripcion: descripcion,
        modelo: modelo
    };

    productos.push(nuevoProducto);
    generarProductos();
    ocultarFormularioProducto();
}

// Eliminar producto
function eliminarProducto(id) {
    if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
        productos = productos.filter(p => p.id !== id);
        generarProductos();
    }
}

// Abrir modal con visualizador 3D y ejes
function openModal(productName, modelPath) {
    document.getElementById('modalTitle').textContent = productName;
    document.getElementById('modelModal').style.display = 'block';

    const viewer = document.getElementById('modalViewer');
    viewer.innerHTML = '';

    // Crear nueva escena 3D usando la clase reutilizable
    const modalViewer = new ProductoViewer3D();

    modalScene = new THREE.Scene();
    modalCamera = new THREE.PerspectiveCamera(60, viewer.clientWidth / viewer.clientHeight, 0.1, 1000);
    modalRenderer = new THREE.WebGLRenderer({ antialias: true });

    modalRenderer.setSize(viewer.clientWidth, viewer.clientHeight);
    modalRenderer.setClearColor(0x222222);
    viewer.appendChild(modalRenderer.domElement);

    // Controles de órbita
    modalControls = new THREE.OrbitControls(modalCamera, modalRenderer.domElement);
    modalControls.enableDamping = true;
    modalControls.dampingFactor = 0.1;
    modalControls.enablePan = true;
    modalControls.target.set(0, 0, 0);

    modalCamera.position.set(3, 2.5, 3);

    // Agregar ejes de coordenadas usando el método reutilizable
    axesHelper = modalViewer.createAxesHelper(3);
    modalScene.add(axesHelper);

    // Luz ambiental
    modalScene.add(new THREE.AmbientLight(0xffffff, 0.4));

    // Luz direccional
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 5, 5);
    modalScene.add(directionalLight);

    // Cargar modelo GLTF
    const loader = new THREE.GLTFLoader();
    loader.load(modelPath, function(gltf) {
        const model = gltf.scene;

        // Ocultar elementos no deseados
        model.traverse((child) => {
            if (child.isMesh) {
                const name = child.name.toLowerCase();
                if (name.includes('mesa') || name.includes('ground') || name.includes('floor')) {
                    child.visible = false;
                }
            }
        });

        modalScene.add(model);

        // Centrar modelo
        const box = new THREE.Box3().setFromObject(model);
        const center = new THREE.Vector3();
        box.getCenter(center);
        model.position.sub(center);

        model.scale.set(2, 2, 2);

    }, undefined, function(error) {
        console.error('Error cargando modelo:', error);
        // Crear placeholder
        const geometry = new THREE.BoxGeometry(2, 2, 2);
        const material = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
        const cube = new THREE.Mesh(geometry, material);
        modalScene.add(cube);
    });

    // Iniciar animación
    animateModal();
}

function animateModal() {
    requestAnimationFrame(animateModal);
    if (modalControls) modalControls.update();
    if (modalRenderer && modalScene && modalCamera) {
        modalRenderer.render(modalScene, modalCamera);
    }
}

// Cerrar modal
function closeModal() {
    document.getElementById('modelModal').style.display = 'none';
    if (modalRenderer) {
        modalRenderer.dispose();
        modalRenderer = null;
    }
    if (modalControls) {
        modalControls.dispose();
        modalControls = null;
    }
    modalScene = null;
    modalCamera = null;
    axesHelper = null;
}

// Cerrar modal al hacer click fuera
window.onclick = function(event) {
    const modal = document.getElementById('modelModal');
    if (event.target == modal) {
        closeModal();
    }
}

// Inicializar cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    generarProductos();
});
</script>
{% endblock %}